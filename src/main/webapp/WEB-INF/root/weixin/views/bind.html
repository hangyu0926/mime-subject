<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>曦域</title>
    <script type="text/javascript" src="../resources/javascript/jquery-1.11.0.min.js"></script>
    <script src="../resources/javascript/mui.min.js"></script>
    <script type="text/javascript" src="../resources/javascript/adapt.js"></script>
    <script type="text/javascript" src="../resources/javascript/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../resources/javascript/md5.js"></script>
    <script type="text/javascript" src="../resources/javascript/validate.js"></script>
    <script type="text/javascript" src="../resources/javascript/dialog.js"></script>
    <script type="text/javascript" src="../resources/javascript/main.js"></script>
    <link href="../resources/style/mui.min.css" rel="stylesheet" />
    <link href="../resources/style/wxmain.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="../resources/style/alert.css">
    <script type="text/javascript" charset="utf-8">
    mui.init();
    function locationHref() {
        var localhost = window.location.href;
        return {
            href: function() {
                var s1 = localhost.split("?")[1].split("&")[0].split("=")[1];
                var s2 = localhost.split("?")[1].split("&")[1].split("=")[1];
                return {
                    "state": s1,
                    "WXID": s2
                }
            }
        };
    };
    // 点击修改密码
    function showUpdatePasswordDialog() {
        $("body").css("background-color","#fafafa");
        var loginDialog = document.getElementById('loginDialog'),
            updatePasswordDialog = document.getElementById('updatePasswordDialog');
        mui('#loginDialog input').each(function(index, element) {
            this.value = '';
        });
        mui('#updatePasswordDialog input').each(function(index, element) {
            this.value = '';
        });
        loginDialog.style.display = 'none';
        updatePasswordDialog.style.display = 'block';
    };

    // 点击回到登录
    function goBackLogin() {
        var loginDialog = document.getElementById('loginDialog'),
            updatePasswordDialog = document.getElementById('updatePasswordDialog');
        mui('#loginDialog input').each(function(index, element) {
            this.value = '';
        });
        mui('#updatePasswordDialog input').each(function(index, element) {
            this.value = '';
        });
        loginDialog.style.display = 'block';
        updatePasswordDialog.style.display = 'none';
    };
    $(function() {
        judgeAutoInput();
        $('#loginPassword').focus(function() {
            if ($(this).val() == '******************') {
                $(this).val('');
            }
        })
    });
    // localStorage封装
    function setLocalStorage(key, value) {
        var curTime = new Date().getTime();
        localStorage.setItem(key, JSON.stringify({
            data: value,
            time: curTime
        }));
    }

    function getLocalStorage(key, exp) {
        var data = localStorage.getItem(key);
        if (!data) {
            return undefined;
        };
        var dataObj = JSON.parse(data);
        if (new Date().getTime() - dataObj.time > exp) {
            localStorage.removeItem(key);
            return undefined;
        } else {
            var dataObjDatatoJson = dataObj.data
            return dataObjDatatoJson;
        };
    };

    function judgeAutoInput() {
        // 判断是否需要自动登陆
        if (!global_validate.objectIsEmpty(getLocalStorage('remember_userMobile', 1000 * 60 * 60 * 24 * 15)) && !global_validate.objectIsEmpty(getLocalStorage('remember_userMobile', 1000 * 60 * 60 * 24 * 15))) {
            $('#loginUserName').val(getLocalStorage('remember_userMobile', 1000 * 60 * 60 * 24 * 15));
            $('#loginPassword').val('******************');
            $('#loginRealPsw').val(getLocalStorage('remember_password', 1000 * 60 * 60 * 24 * 15));
        };
    };
    function fadeIn(str){
         $(".errorDialog").css("opacity", "0.5");
            $(".errorDialog").text(str);
            setTimeout(function() {
                $(".errorDialog").css("opacity", "0");
            }, 3000);
    }
    function login() {
        // 登录操作
        // 参数获取，验证
        var username = $('#loginUserName>input').val();
        var password = $('#loginPassword>input').val();
        // var isRemember = true;
        // if (password == '******************') {
        //     isRemember = false;
        //     password = $('#loginRealPsw').val();
        // };
        if (global_validate.stringIsEmpty(username)) {
           fadeIn("请填写完整");
            return;
        };
        if (global_validate.stringIsEmpty(password)) {
            fadeIn("请输入登录密码");
            return;
        };
        if (!global_validate.userIsok(username)) {
            fadeIn("账号有误");
            return;
        }
        if (!global_validate.passwordIsOk(password)) {
            fadeIn("密码有误");
            return;
        }
        // if (isRemember) {
            password = hex_md5(password);
        // };
        $("#loginDialog-login").addClass("isClick");
        // 数据提交，成功进入主界面
        global_ajax('login', {
            'userMobile': username,
            'password': password,
            "wxUserId": locationHref().href()["WXID"],
            "state": locationHref().href()["state"]
        }, function(data) {
            var parameterw = locationHref().href()["state"];
            var parameter = '';
            if (!isNaN(parameterw)) {
                parameter = "http://xypmstest.xiyucapital.com:8080/xypms/weixin/views/info.html?projectId=";
            } else {
                parameter = "http://xypmstest.xiyucapital.com:8080/xypms/weixin/views/list.html?type=";
            };
            setLocalStorage("remember_userMobile", username);
            setLocalStorage("remember_password", password);
            history.replaceState({}, "", 'list.html');
            // 登录信息保存
            window.location.href = parameter + parameterw;
        }, "post", function(data) {
             $("#loginDialog-login").removeClass("isClick");
            $(".errorDialog").css("opacity", "0.5");
            $(".errorDialog").text(data.desc);
            setTimeout(function() {
                $(".errorDialog").css("opacity", "0");
            }, 3000);
        });
    };
    function updatePassword() {
        if($(".xy-wx-login-button-margin").hasClass("isClick")){
            return
        };
        // 修改密码操作
        // 参数获取，验证
        var username = $('#updatePswUserName').val();
        var oldPassword = $('#updatePswOldPsw').val();
        var newPassword = $('#updatePswNewPsw').val();
        var reNewPassword = $('#updatePswReNewPsw').val();
        if (global_validate.stringIsEmpty(username) || global_validate.stringIsEmpty(oldPassword) || global_validate.stringIsEmpty(newPassword) || global_validate.stringIsEmpty(reNewPassword)) {
             fadeIn("请填写完整");
            return;
        }
        if (!global_validate.userIsok(username)) {
             fadeIn("账号有误");
            return;
        }
        if (!global_validate.passwordIsOk(oldPassword)) {
            fadeIn("旧密码有误");
            return;
        }
        if (oldPassword == newPassword) {
            fadeIn("输入的新旧密码相同");
            return;
        }
        if (newPassword != reNewPassword) {
            fadeIn("两次密码输入不一致");
            return;
        }
        if (!global_validate.passwordIsOk(newPassword)) {
            fadeIn("新密码格式有误");
            return;
        }
        $(".xy-wx-login-button-margin").addClass("isClick");
        oldPassword = hex_md5(oldPassword);
        newPassword = hex_md5(newPassword);
        // 数据提交，成功回到登录
        global_ajax('updatePassword', {
            'userMobile': username,
            'oldPassword': oldPassword,
            'newPassword': newPassword
        }, function(data) {
             $(".xy-wx-login-button-margin").removeClass("isClick");
            fadeIn("修改密码成功");
            // $('#loginUserName').val(username);
            // $('#loginPassword').val('******************');
            // $('#loginRealPsw').val(newPassword);
            showLoginDialog(true);
        }, "post", function(data) {
             $(".xy-wx-login-button-margin").removeClass("isClick");
            $(".errorDialog").css("opacity", "0.5");
            $(".errorDialog").text(data.desc);
            setTimeout(function() {
                $(".errorDialog").css("opacity", "0");
            }, 3000);
        });
    };
    // 显示输入登录框
    function showLoginDialog(isReset) {
        $("body").css("background-color","#fff");
        if (!isReset) {
            $('#loginUserName').val('');
            $('#loginPassword').val('');
        };
        $("#updatePasswordDialog").hide();
        $("#loginDialog").show();
    };
    </script>
</head>

<body>
    <div id="loginDialog">
        <div id="loginImg"></div>
        <div id="loginUserName">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" oninput="if(value.length>11)value=value.slice(0,11)"  onfocus="this.placeholder=''" onblur="this.placeholder='请输入账号/手机号'" placeholder="请输入账号/手机号">
        </div>
        <div id="loginPassword">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')"  oninput="if(value.length>6)value=value.slice(0,6)" onfocus="this.placeholder=''" onblur="this.placeholder='请输入6位密码'" maxlength="6" placeholder="请输入6位密码">
            <input type="hidden" id="loginRealPsw" />
        </div>
        <div id="loginDialog-login" onclick="login()">登录</div>
        <span class="errorDialog"></span>
        <div id="loginDialog-modify">
            <span class="loginDialog-modify-first" onclick="showUpdatePasswordDialog()">修改密码</span><span class="loginDialog-hr"></span>
            <!-- <span class="loginDialog-modify-third">忘记密码</span> -->
            <a class="loginDialog-modify-third" href="tel:4008009999">忘记密码</a>
        </div>
    </div>
    <div class="mui-input-group after-none xy-wx-login xy-wx-login-updatePassword" id="updatePasswordDialog">
        <div class="mui-input-row">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" id="updatePswUserName" oninput="if(value.length>11)value=value.slice(0,11)" onfocus="this.placeholder=''" onblur="this.placeholder='请输入账号/手机号'" placeholder="请输入账号/手机号">
        </div>
        <div class="mui-input-row">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" id="updatePswOldPsw" onfocus="this.placeholder=''" onblur="this.placeholder='请输入6位旧密码'" oninput="if(value.length>6)value=value.slice(0,6)" placeholder="请输入6位旧密码">
        </div>
        <div class="mui-input-row">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" id="updatePswNewPsw" onfocus="this.placeholder=''" onblur="this.placeholder='请输入6位新密码'" oninput="if(value.length>6)value=value.slice(0,6)" placeholder="请输入6位新密码">
        </div>
        <div class="mui-input-row" id="mui-input-row-last">
            <input type="number" onkeyup="this.value=this.value.replace(/\D/g,'')" onafterpaste="this.value=this.value.replace(/\D/g,'')" id="updatePswReNewPsw" onfocus="this.placeholder=''" onblur="this.placeholder='请再次输入新密码'" oninput="if(value.length>6)value=value.slice(0,6)" placeholder="请再次输入新密码">
        </div>
        <span class="errorDialog errorDialogtwo"></span>
        <!--  <div class="mui-input-row xy-wx-operation-margin after-none">
            <span class="xy-wx-forgetPassword" onclick="goBackLogin()">已有账号，快去登录&nbsp;&nbsp;></span>
        </div> -->
        <div class="xy-wx-login-button-margin" onclick="updatePassword()">完成</div>
    </div>
    <!-- <div id="position" style="display: none;"> -->
   <!--  <div class="mui-popup mui-popup-in" >
        <div class="mui-popup-inner">
            <div class="mui-popup-title">拨打电话</div>
            <div class="mui-popup-text">确认拨打客服电话<a href="tel:4008009999">400 800 9999</a>?</div>
        </div>
        <div class="mui-popup-buttons">
        <span class="doQuxiao">取消</span>
        <a href="tel:4008009999" class="doSure">确定</a>
        </div>
    </div> -->
    </div>
</body>

</html>
